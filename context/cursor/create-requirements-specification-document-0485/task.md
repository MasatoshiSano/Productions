# マッチングサイトアプリ タスク一覧

## 📋 概要

Django + Bootstrap 5を使用したマッチングサイトアプリケーションを実装する。
ユーザー認証、プロフィール管理、マッチング機能、リアルタイムメッセージング、管理機能を含む。

## 🎯 確定済み仕様

### 技術仕様
- **位置情報**: 郵便番号ベースでの距離計算（50km以内）
- **郵便番号API**: zipcloud API（無料）を使用した座標変換
- **年齢認証**: 生年月日入力による自己申告
- **画像処理**: Django標準のmedia files、800x800px、最大5MB、JPEG/PNG対応
- **リアルタイム通信**: Redis + Django Channels（単一サーバー構成）
- **デザイン**: PC・モバイル両対応、マッチングサイト適応カラー
- **セキュリティ**: Django標準セキュリティ機能
- **デプロイ**: Docker化 + 基本的なデプロイ手順
- **テスト**: 基本的な単体テスト

### プロフィール項目
- **必須項目**: 名前、年齢、性別、都道府県、郵便番号、プロフィール写真
- **任意項目**: 職業、自己紹介

### マッチング条件
- **年齢範囲**: ユーザー設定可能（制限なし）
- **距離**: 50km以内（郵便番号ベース）

### 通知機能
- **メール通知**: 即座送信
- **ブラウザ通知**: 即座表示
- **通知内容**: マッチング成立、メッセージ受信

## ✅ タスクリスト

### フェーズ1: プロジェクトセットアップとユーザー認証

#### 1. **Djangoプロジェクト初期セットアップ**
- 概要: Django プロジェクトの基本構成とアプリケーション構造を作成
- 完了条件:
  - [ ] Django プロジェクト作成 (`matching_site`)
  - [ ] アプリケーション作成 (`accounts`, `matching`, `messaging`, `core`)
  - [ ] `settings.py` 設定完了（Bootstrap 5, Redis, Channels, 静的ファイル設定）
  - [ ] `requirements.txt` 作成完了（Django, Channels, Redis, Pillow, requests含む）
  - [ ] `MEDIA_ROOT` と `MEDIA_URL` 設定完了
- 動作確認:
  - [ ] `python manage.py runserver` で起動確認
  - [ ] Bootstrap 5 の読み込み確認
  - [ ] Redis接続確認
  - [ ] メディアファイル配信確認
- メモ: zipcloud API用のrequestsライブラリも含める

#### 2. **カスタムUserモデルの作成**
- 概要: AbstractUserを継承したカスタムUserモデルを作成
- 完了条件:
  - [ ] `accounts/models.py` にCustomUserモデル作成
  - [ ] `AUTH_USER_MODEL` 設定完了
  - [ ] 生年月日フィールド追加（年齢計算用）
  - [ ] 初期マイグレーション実行完了
- 動作確認:
  - [ ] `python manage.py test accounts` で通過
  - [ ] 管理画面でユーザー作成・編集確認
  - [ ] 18歳以上バリデーション確認
- メモ: 生年月日から年齢を自動計算するプロパティメソッド追加

#### 3. **ユーザー登録機能の実装**
- 概要: ユーザー登録フォームとビューを作成
- 完了条件:
  - [ ] `accounts/forms.py` に登録フォーム作成
  - [ ] `accounts/views.py` に登録ビュー作成
  - [ ] 生年月日による18歳以上バリデーション実装
  - [ ] 登録確認メール送信機能実装
  - [ ] CSRF保護の適切な設定
- 動作確認:
  - [ ] `/accounts/signup/` で登録フォーム表示
  - [ ] 18歳未満の登録拒否確認
  - [ ] 確認メール送信確認
  - [ ] CSRFトークン動作確認
- メモ: django-allauthまたはDjango標準機能を使用

#### 4. **ログイン・ログアウト機能の実装**
- 概要: Django標準認証を使用したログイン・ログアウト機能
- 完了条件:
  - [ ] `accounts/views.py` にログイン・ログアウトビュー作成
  - [ ] ログイン状態保持機能実装
  - [ ] パスワード忘れ機能実装
  - [ ] ログイン後プロフィール作成強制リダイレクト
  - [ ] セッション管理の適切な設定
- 動作確認:
  - [ ] `/accounts/login/` でログイン確認
  - [ ] `/accounts/logout/` でログアウト確認
  - [ ] パスワードリセット機能確認
  - [ ] セッション期限切れ確認
- メモ: CSRFトークンの適切な設定を確認

#### 5. **認証機能のテスト作成**
- 概要: 認証機能に対する単体テストを作成
- 完了条件:
  - [ ] `accounts/tests/test_models.py` 作成
  - [ ] `accounts/tests/test_views.py` 作成
  - [ ] `accounts/tests/test_forms.py` 作成
  - [ ] 年齢バリデーションテスト作成
  - [ ] 認証フローテスト作成
- 動作確認:
  - [ ] `python manage.py test accounts` で全テストパス
  - [ ] カバレッジ80%以上確認
- メモ: TestCaseとClientを使用したセッションテスト実装

### フェーズ2: プロフィール管理機能

#### 6. **Profileモデルの作成**
- 概要: ユーザープロフィール情報を管理するモデル作成
- 完了条件:
  - [ ] `accounts/models.py` にProfileモデル作成
  - [ ] Userとの1対1関係設定
  - [ ] 必須フィールド: 性別、都道府県、郵便番号、プロフィール写真
  - [ ] 任意フィールド: 職業、自己紹介（500文字制限）
  - [ ] 写真アップロード機能実装（最大6枚、800x800px、最大5MB）
  - [ ] 緯度・経度フィールド追加
- 動作確認:
  - [ ] `python manage.py test accounts` で通過
  - [ ] 管理画面でプロフィール作成・編集確認
  - [ ] 画像リサイズ確認
- メモ: Pillowを使用した画像処理・リサイズ機能を含める

#### 7. **zipcloud APIによる座標変換機能の実装**
- 概要: zipcloud APIを使用して郵便番号から緯度経度を取得
- 完了条件:
  - [ ] `core/utils.py` にzipcloud API呼び出し関数作成
  - [ ] 距離計算機能実装（50km以内検索）
  - [ ] APIエラーハンドリング実装
  - [ ] プロフィール保存時に座標自動取得
  - [ ] レート制限対応（APIコール制限）
- 動作確認:
  - [ ] 郵便番号入力で座標取得確認
  - [ ] 距離計算の精度確認
  - [ ] 50km以内ユーザー検索確認
  - [ ] APIエラー時の適切な処理確認
- メモ: zipcloud APIの利用規約を確認し、適切なリクエスト頻度で実装

#### 8. **プロフィール作成・編集フォームの実装**
- 概要: プロフィール作成・編集用のフォームクラス作成
- 完了条件:
  - [ ] `accounts/forms.py` にProfileFormクラス作成
  - [ ] 必須項目バリデーション実装
  - [ ] 写真アップロード機能実装（6枚まで、ファイルサイズ・形式チェック）
  - [ ] 郵便番号形式バリデーション実装
  - [ ] 画像の悪意あるファイル基本チェック
- 動作確認:
  - [ ] プロフィール作成フォーム表示確認
  - [ ] 画像アップロード動作確認
  - [ ] バリデーションエラー表示確認
  - [ ] 不正ファイル拒否確認
- メモ: ModelFormを使用し、Bootstrap 5でスタイリング

#### 9. **プロフィール表示・編集ビューの実装**
- 概要: プロフィール表示・編集用のビュークラス作成
- 完了条件:
  - [ ] `accounts/views.py` にProfileViewクラス作成
  - [ ] 認証必須デコレータ適用
  - [ ] プロフィール未作成時の作成強制
  - [ ] 他ユーザーのプロフィール閲覧機能
  - [ ] プロフィール画像の適切な配信
- 動作確認:
  - [ ] `/profile/` でプロフィール表示確認
  - [ ] プロフィール編集機能確認
  - [ ] 未作成時のリダイレクト確認
  - [ ] 画像表示確認
- メモ: LoginRequiredMixinを使用

### フェーズ3: マッチング機能

#### 10. **マッチング関連モデルの作成**
- 概要: Like, Match, Blockモデルを作成
- 完了条件:
  - [ ] `matching/models.py` にLike, Match, Blockモデル作成
  - [ ] 適切なリレーション設定
  - [ ] 重複防止制約設定
  - [ ] インデックス設定（検索高速化）
  - [ ] 作成日時フィールドにインデックス設定
- 動作確認:
  - [ ] `python manage.py test matching` で通過
  - [ ] 管理画面でモデル確認
  - [ ] 重複制約動作確認
- メモ: unique_togetherを使用して重複防止

#### 11. **ユーザー発見機能の実装**
- 概要: マッチング候補ユーザーを表示する機能
- 完了条件:
  - [ ] `matching/views.py` にDiscoveryViewクラス作成
  - [ ] 郵便番号ベース50km以内フィルタリング実装
  - [ ] 年齢範囲フィルタリング実装（ユーザー設定可能）
  - [ ] 既にいいね/パス/ブロックしたユーザーの除外
  - [ ] データベースクエリ最適化（select_related, prefetch_related）
- 動作確認:
  - [ ] `/discover/` でユーザー候補表示確認
  - [ ] 距離・年齢フィルタリング確認
  - [ ] カード形式UI確認
  - [ ] クエリパフォーマンス確認
- メモ: Bootstrap 5カードコンポーネントを使用

#### 12. **いいね・パス機能の実装**
- 概要: ユーザーへのいいね・パス機能とマッチング判定
- 完了条件:
  - [ ] `matching/views.py` にLikeView, PassView作成
  - [ ] Ajax対応（ページリロードなし）
  - [ ] マッチング成立判定ロジック実装
  - [ ] マッチング成立時の即座通知機能
  - [ ] CSRFトークン対応
- 動作確認:
  - [ ] いいね・パスボタン動作確認
  - [ ] マッチング成立通知確認
  - [ ] Ajax通信確認
  - [ ] CSRF保護確認
- メモ: vanilla JavaScriptを使用

#### 13. **マッチング一覧機能の実装**
- 概要: マッチしたユーザーの一覧表示機能
- 完了条件:
  - [ ] `matching/views.py` にMatchListViewクラス作成
  - [ ] 最新メッセージプレビュー表示
  - [ ] 未読メッセージ表示
  - [ ] メッセージ画面へのリンク
  - [ ] ページネーション実装
- 動作確認:
  - [ ] `/matches/` でマッチング一覧表示確認
  - [ ] メッセージプレビュー確認
  - [ ] ページネーション確認
- メモ: select_related, prefetch_relatedでクエリ最適化

### フェーズ4: メッセージング機能

#### 14. **メッセージモデルの作成**
- 概要: メッセージデータを管理するモデル作成
- 完了条件:
  - [ ] `messaging/models.py` にMessageモデル作成
  - [ ] 送信者・受信者のリレーション設定
  - [ ] 既読・未読状態管理
  - [ ] メッセージタイプ（テキスト/画像）対応
  - [ ] created_atにインデックス設定
- 動作確認:
  - [ ] `python manage.py test messaging` で通過
  - [ ] 管理画面でメッセージ確認
  - [ ] インデックス動作確認
- メモ: created_atにインデックス設定

#### 15. **Redis + Django Channels設定（単一サーバー）**
- 概要: リアルタイムメッセージング用のChannels設定
- 完了条件:
  - [ ] `settings.py` にChannels設定追加
  - [ ] Redis接続設定（単一サーバー構成）
  - [ ] `asgi.py` 設定完了
  - [ ] `routing.py` 作成
  - [ ] 開発環境用Redis設定
- 動作確認:
  - [ ] Redis接続確認
  - [ ] Channels起動確認
  - [ ] WebSocket接続テスト
- メモ: 単一サーバー構成での最適化

#### 16. **WebSocketコンシューマー実装**
- 概要: リアルタイムメッセージング用のWebSocketConsumer
- 完了条件:
  - [ ] `messaging/consumers.py` にChatConsumer作成
  - [ ] メッセージ送受信機能実装
  - [ ] 認証チェック実装
  - [ ] チャンネルグループ管理
  - [ ] エラーハンドリング実装
- 動作確認:
  - [ ] WebSocket接続確認
  - [ ] リアルタイムメッセージ送受信確認
  - [ ] 複数ユーザーでの同時接続確認
  - [ ] 認証エラー処理確認
- メモ: 認証済みユーザーのみ接続許可

#### 17. **メッセージ送信・表示機能の実装**
- 概要: メッセージ送信フォームとチャット画面
- 完了条件:
  - [ ] `messaging/views.py` にChatViewクラス作成
  - [ ] メッセージ送信API実装
  - [ ] 既読・未読管理機能
  - [ ] マッチしたユーザー間のみアクセス制限
  - [ ] ページネーション実装
- 動作確認:
  - [ ] チャット画面表示確認
  - [ ] メッセージ送信確認
  - [ ] 既読機能確認
  - [ ] アクセス制限確認
- メモ: ページネーション実装

### フェーズ5: 通知・管理機能

#### 18. **通知システムの実装**
- 概要: メール・ブラウザ通知機能
- 完了条件:
  - [ ] `core/notification.py` に通知システム作成
  - [ ] マッチング成立時の即座メール送信
  - [ ] メッセージ受信時の即座メール送信
  - [ ] ブラウザ通知API実装
  - [ ] 通知の重複送信防止機能
- 動作確認:
  - [ ] 各種通知機能確認
  - [ ] 通知タイミング確認
  - [ ] 重複送信防止確認
- メモ: 通知の重複送信防止機能

#### 19. **ブロック・報告機能の実装**
- 概要: ユーザーブロック・不適切ユーザー報告機能
- 完了条件:
  - [ ] `matching/models.py` にReportモデル作成
  - [ ] ブロック・報告フォーム作成
  - [ ] ブロックユーザーの表示除外機能
  - [ ] 管理者への報告通知機能
  - [ ] 報告理由の分類機能
- 動作確認:
  - [ ] ブロック機能確認
  - [ ] 報告機能確認
  - [ ] ブロックユーザー除外確認
  - [ ] 管理者通知確認
- メモ: 報告理由の分類機能を含める

#### 20. **管理者機能の実装**
- 概要: 管理者用のカスタム機能
- 完了条件:
  - [ ] Django admin拡張
  - [ ] ユーザーアカウント削除機能
  - [ ] 不適切コンテンツ削除機能
  - [ ] ユーザーブロック/凍結機能
  - [ ] 基本統計情報表示
- 動作確認:
  - [ ] 管理画面アクセス確認
  - [ ] 各種管理機能確認
  - [ ] 統計情報表示確認
- メモ: 管理者権限の適切な設定

#### 21. **分析ダッシュボード機能の実装**
- 概要: 管理者向けの分析ダッシュボード
- 完了条件:
  - [ ] `core/admin_views.py` にダッシュボードビュー作成
  - [ ] ユーザー登録数グラフ表示
  - [ ] マッチング成立率グラフ表示
  - [ ] メッセージ送信統計グラフ表示
  - [ ] 日次・週次・月次統計切り替え
  - [ ] Chart.jsを使用したグラフ表示
- 動作確認:
  - [ ] ダッシュボード画面表示確認
  - [ ] 各種グラフ表示確認
  - [ ] 統計期間切り替え確認
- メモ: Chart.jsライブラリを使用してグラフ表示

### フェーズ6: UI/UX・デプロイメント

#### 22. **Bootstrap 5による UI実装**
- 概要: レスポンシブデザインとマッチングサイト適応デザイン
- 完了条件:
  - [ ] 全画面のBootstrap 5対応
  - [ ] PC・モバイル両対応レスポンシブデザイン
  - [ ] マッチングサイト適応カラーテーマ
  - [ ] Bootstrap Iconsの活用
  - [ ] カスタムエラーページ（404, 500）作成
- 動作確認:
  - [ ] モバイル表示確認
  - [ ] タブレット表示確認
  - [ ] デスクトップ表示確認
  - [ ] エラーページ表示確認
- メモ: 有名マッチングサイトのUIを参考

#### 23. **パフォーマンス最適化**
- 概要: データベースクエリ最適化と画像最適化
- 完了条件:
  - [ ] データベースクエリ最適化（select_related, prefetch_related）
  - [ ] 画像自動リサイズ・圧縮
  - [ ] 静的ファイル圧縮
  - [ ] 基本的なキャッシュ戦略実装
  - [ ] Django Debug Toolbarでの確認
- 動作確認:
  - [ ] ページ読み込み速度確認
  - [ ] データベースクエリ数確認
  - [ ] 画像読み込み速度確認
- メモ: Django Debug Toolbarで確認

#### 24. **Docker化とデプロイメント**
- 概要: Dockerコンテナ化と基本的なデプロイ手順
- 完了条件:
  - [ ] `Dockerfile` 作成
  - [ ] `docker-compose.yml` 作成（Django, PostgreSQL, Redis）
  - [ ] 環境変数設定（`.env` ファイル）
  - [ ] 本番環境用設定ファイル作成
  - [ ] デプロイメント手順書作成
- 動作確認:
  - [ ] Docker build確認
  - [ ] docker-compose up確認
  - [ ] 本番環境でのデプロイ確認
- メモ: PostgreSQLとRedisもコンテナ化

#### 25. **統合テスト**
- 概要: 全機能の統合テストとエンドツーエンドテスト
- 完了条件:
  - [ ] 全機能統合テスト作成
  - [ ] ユーザーシナリオテスト
  - [ ] API動作テスト
  - [ ] セキュリティテスト（基本的なもの）
  - [ ] テストデータ作成
- 動作確認:
  - [ ] 全テストパス確認
  - [ ] 実際のユーザーシナリオテスト
  - [ ] セキュリティテスト確認
- メモ: テストデータの作成も含める

---

## 📊 進捗管理

### 現在の状況
- [ ] フェーズ1: プロジェクトセットアップとユーザー認証 (0/5)
- [ ] フェーズ2: プロフィール管理機能 (0/4)
- [ ] フェーズ3: マッチング機能 (0/4)
- [ ] フェーズ4: メッセージング機能 (0/4)
- [ ] フェーズ5: 通知・管理機能 (0/4)
- [ ] フェーズ6: UI/UX・デプロイメント (0/4)

### 全体進捗: 0/25 タスク完了

### 実装順序の依存関係
```
フェーズ1 → フェーズ2 → フェーズ3 → フェーズ4 → フェーズ5 → フェーズ6
     ↓        ↓        ↓        ↓        ↓        ↓
   必須基盤   必須基盤   コア機能   コア機能   付加機能   仕上げ
```

### 新規追加項目
- **zipcloud API**: 無料の郵便番号→座標変換API
- **Django media files**: 標準的な画像保存・配信
- **Redis単一サーバー**: スケールアウトしない構成
- **Docker化**: 本番環境へのデプロイ対応
- **分析ダッシュボード**: Chart.jsを使用したグラフ表示

**注意**: 各フェーズの完了後、必ず `python manage.py test` でのテスト実行を確認してください。

---

## 🔗 関連ドキュメント

- 実装要件: [specification.md](./specification.md)
- 設計方針: [design-doc.md](../../../design-doc.md)
- タスク分割指針: [make-task.md](../../../plan/make-task.md)